find_package(Catch2 CONFIG REQUIRED)
find_package(mcap CONFIG REQUIRED)
find_package(Protobuf CONFIG QUIET)
if (NOT TARGET protobuf::libprotobuf
    AND NOT TARGET Protobuf::libprotobuf
    AND NOT TARGET protobuf::protobuf
    AND NOT TARGET Protobuf::protobuf)
  find_package(protobuf CONFIG REQUIRED)
endif()

set(PROTOBUF_LIB_TARGET "")
if (TARGET protobuf::libprotobuf)
  set(PROTOBUF_LIB_TARGET protobuf::libprotobuf)
elseif (TARGET Protobuf::libprotobuf)
  set(PROTOBUF_LIB_TARGET Protobuf::libprotobuf)
elseif (TARGET protobuf::protobuf)
  set(PROTOBUF_LIB_TARGET protobuf::protobuf)
elseif (TARGET Protobuf::protobuf)
  set(PROTOBUF_LIB_TARGET Protobuf::protobuf)
endif()

set(PROTOBUF_PROTOC_TARGET "")
if (TARGET protobuf::protoc)
  set(PROTOBUF_PROTOC_TARGET protobuf::protoc)
elseif (TARGET Protobuf::protoc)
  set(PROTOBUF_PROTOC_TARGET Protobuf::protoc)
endif()

if (NOT PROTOBUF_LIB_TARGET OR NOT PROTOBUF_PROTOC_TARGET)
  message(FATAL_ERROR "Protobuf targets not found; check Conan CMakeDeps output.")
endif()

FILE(GLOB all_protos "proto/foxglove/*.proto")

FOREACH(f ${all_protos})
    file(RELATIVE_PATH f ${CMAKE_CURRENT_SOURCE_DIR}/proto ${f})
    STRING(REGEX REPLACE "\\.proto$" "" f ${f})
    LIST(APPEND proto_sources "autogenerated/${f}.pb.h")
    LIST(APPEND proto_sources "autogenerated/${f}.pb.cc")
ENDFOREACH(f)

add_custom_command(
    OUTPUT ${proto_sources}
    COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/autogenerated
    COMMAND $<TARGET_FILE:${PROTOBUF_PROTOC_TARGET}> --proto_path=${CMAKE_CURRENT_SOURCE_DIR}/proto
            --cpp_out=${CMAKE_CURRENT_BINARY_DIR}/autogenerated ${all_protos}
    DEPENDS ${all_protos}
)

add_library(foxglove_proto_lib ${proto_sources})
target_link_libraries(foxglove_proto_lib PUBLIC ${PROTOBUF_LIB_TARGET})
target_include_directories(foxglove_proto_lib PUBLIC ${CMAKE_CURRENT_BINARY_DIR}/autogenerated)
# Unfortunately the protobuf library headers include some unused parameters, which have to be
# downgraded back to warnings for all targets that depends on them.
if (MSVC)
    target_compile_options(foxglove_proto_lib PUBLIC /wd4100 /wd4267 /wd4244)
else()
    target_compile_options(foxglove_proto_lib PUBLIC -Wno-error=unused-parameter)
endif()

add_executable(example_protobuf_writer writer.cpp BuildFileDescriptorSet.cpp)
target_link_libraries(example_protobuf_writer PRIVATE mcap::mcap foxglove_proto_lib)
target_compile_definitions(example_protobuf_writer PRIVATE _USE_MATH_DEFINES)

add_executable(example_protobuf_dynamic_reader dynamic_reader.cpp)
target_link_libraries(example_protobuf_dynamic_reader PRIVATE mcap::mcap ${PROTOBUF_LIB_TARGET})
if (MSVC)
    target_compile_options(example_protobuf_dynamic_reader PUBLIC /wd4100)
else()
    target_compile_options(example_protobuf_dynamic_reader PUBLIC -Wno-error=unused-parameter)
endif()

add_executable(example_protobuf_static_reader static_reader.cpp)
target_link_libraries(example_protobuf_static_reader PRIVATE mcap::mcap foxglove_proto_lib)
if (MSVC)
    target_compile_options(example_protobuf_static_reader PUBLIC /wd4100)
else()
    target_compile_options(example_protobuf_static_reader PUBLIC -Wno-error=unused-parameter)
endif()

add_executable(example_protobuf_unit_tests unit_tests.cpp BuildFileDescriptorSet.cpp)
target_link_libraries(example_protobuf_unit_tests PRIVATE mcap::mcap foxglove_proto_lib Catch2::Catch2)
if (MSVC)
    target_compile_options(example_protobuf_unit_tests PUBLIC /wd4100)
else()
    target_compile_options(example_protobuf_unit_tests PUBLIC -Wno-error=unused-parameter)
endif()
