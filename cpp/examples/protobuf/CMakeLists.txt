find_package(mcap REQUIRED CONFIG)
find_package(Protobuf REQUIRED MODULE)
find_package(Catch2 REQUIRED CONFIG)

FILE(GLOB all_protos "${CMAKE_CURRENT_LIST_DIR}/proto/foxglove/*.proto")


add_library(foxglove_proto_lib STATIC)
protobuf_generate(
    TARGET foxglove_proto_lib
    PROTOS ${all_protos}
    IMPORT_DIRS ${CMAKE_CURRENT_LIST_DIR}/proto
    PROTOC_OUT_DIR ${CMAKE_CURRENT_BINARY_DIR}/autogenerated)
target_link_libraries(foxglove_proto_lib PUBLIC protobuf::libprotobuf)
target_include_directories(foxglove_proto_lib PUBLIC ${CMAKE_CURRENT_BINARY_DIR}/autogenerated)
# Unfortunately the protobuf library headers include some unused parameters, shadowing of members and missed constexpr,
# which have to be downgraded back to warnings for all targets that depends on them.
if (MSVC)
    target_compile_options(foxglove_proto_lib PUBLIC /wd4100 /wd4267 /wd4244 /wd4458 /wd4127)
else()
    target_compile_options(foxglove_proto_lib PUBLIC -Wno-error=unused-parameter)
endif()

add_executable(example_protobuf_writer writer.cpp BuildFileDescriptorSet.cpp)
target_link_libraries(example_protobuf_writer mcap::mcap foxglove_proto_lib)
target_compile_definitions(example_protobuf_writer PRIVATE _USE_MATH_DEFINES)

add_executable(example_protobuf_dynamic_reader dynamic_reader.cpp)
target_link_libraries(example_protobuf_dynamic_reader mcap::mcap protobuf::libprotobuf)
if (MSVC)
    target_compile_options(example_protobuf_dynamic_reader PUBLIC /wd4100 /wd4458 /wd4127)
else()
    target_compile_options(example_protobuf_dynamic_reader PUBLIC -Wno-error=unused-parameter)
endif()

add_executable(example_protobuf_static_reader static_reader.cpp)
target_link_libraries(example_protobuf_static_reader mcap::mcap foxglove_proto_lib)

add_executable(example_protobuf_unit_tests unit_tests.cpp BuildFileDescriptorSet.cpp)
target_link_libraries(example_protobuf_unit_tests mcap::mcap foxglove_proto_lib Catch2::Catch2)
